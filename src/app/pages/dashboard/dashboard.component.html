<div class="dashboard-container">
    <!-- Initial Loading Screen -->
    <div class="initial-loading-overlay" *ngIf="isInitialLoading">
        <div class="loading-container">
            <div class="loading-icon">üí∞</div>
            <h2 class="loading-title">{{loadingMessage}}</h2>
            <div class="loading-bar-container">
                <div class="loading-bar" [style.width.%]="loadingProgress"></div>
            </div>
            <p class="loading-percentage">{{loadingProgress | number:'1.0-0'}}%</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-content" *ngIf="!isInitialLoading">
        <!-- Account Overview -->
        <div class="account-overview">
            <h2 class="section-title">Account Overview</h2>

            <!-- Balance Card -->
            <div class="balance-card">
                <div class="balance-header">
                    <h3 class="balance-title">Available Balance</h3>
                    <div class="balance-status" [ngClass]="getBalanceStatus()">
                        {{getBalanceStatusText()}}
                    </div>
                </div>

                <div class="balance-amount">
                    <span class="currency">$</span>
                    <span class="amount">{{currentBalance | number:'1.2-2'}}</span>
                </div>

                <div class="balance-info">
                    <div class="info-item">
                        <span class="info-label">Last update:</span>
                        <span class="info-value">{{lastUpdate | date:'short'}}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Account ID:</span>
                        <span class="info-value">{{accountId}}</span>
                    </div>
                </div>

                <!-- Withdraw Button Section -->
                <div class="balance-actions">
                    <!-- Message de withdrawal pending -->
                    <div class="withdrawal-pending-notice" *ngIf="withdrawalPending">
                        <div class="pending-icon">‚è≥</div>
                        <div class="pending-text">
                            <span class="pending-title">Withdrawal In Progress</span>
                            <span class="pending-subtitle">Your withdrawal is being processed and should complete within
                                1-3 business days.</span>
                        </div>
                    </div>

                    <!-- Bouton de retrait -->
                    <button type="button" class="withdraw-btn"
                        [ngClass]="{'pending': withdrawalPending, 'disabled': !canWithdraw()}"
                        [disabled]="!canWithdraw() || isProcessing" (click)="openWithdrawModal()">
                        <span class="btn-icon" *ngIf="!withdrawalPending">üí≥</span>
                        <span class="btn-icon" *ngIf="withdrawalPending">‚è≥</span>
                        {{getWithdrawButtonText()}}
                    </button>
                </div>
            </div>
        </div>

        <!-- User Selection Section -->
        <div class="user-selection-section">
            <h3 class="section-title">Your Selected Funding Option</h3>

            <!-- Loading State -->
            <div class="selection-card loading-card" *ngIf="isLoadingSelection">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p class="loading-text">Loading your selection...</p>
                </div>
            </div>

            <!-- No Selection State -->
            <div class="selection-card empty-card" *ngIf="!isLoadingSelection && !hasUserSelection()">
                <div class="empty-content">
                    <div class="empty-icon">üìã</div>
                    <h4 class="empty-title">No Funding Option Selected</h4>
                    <p class="empty-text">You haven't selected a funding option yet. Browse our available options to get
                        started.</p>
                    <button type="button" class="form-btn primary-btn" (click)="navigateToOfferSelection()">
                        <span class="btn-icon">üîç</span>
                        Browse Options
                    </button>
                </div>
            </div>

            <!-- Selected Option Display -->
            <div class="selection-card selected-card" *ngIf="!isLoadingSelection && hasUserSelection()">
                <div class="selection-header">
                    <div class="selection-badge" [ngClass]="selectedFundingOption?.type">
                        {{selectedFundingOption?.badge}}
                    </div>
                    <div class="selection-actions">
                        <button type="button" class="action-btn change-btn" (click)="navigateToOfferSelection()"
                            title="Change Selection">
                            <span class="btn-icon">üîÑ</span>
                            Change
                        </button>
                    </div>
                </div>

                <div class="selection-content">
                    <h4 class="selection-title">{{selectedFundingOption?.title}}</h4>
                    <p class="selection-category">{{getSelectedCategoryName()}}</p>

                    <div class="selection-amount">
                        <span class="amount-label">Funding Amount</span>
                        <span class="amount-value">{{getFormattedSelectedAmount()}}</span>
                    </div>

                    <div class="selection-details">
                        <div class="detail-row">
                            <div class="detail-item">
                                <span class="detail-label">Structure:</span>
                                <span class="detail-value">{{selectedFundingOption?.structure}}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Term:</span>
                                <span class="detail-value">{{selectedFundingOption?.term}}</span>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-item">
                                <span class="detail-label">Payment:</span>
                                <span class="detail-value">{{selectedFundingOption?.payment}}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Frequency:</span>
                                <span class="detail-value">{{selectedFundingOption?.frequency}}</span>
                            </div>
                        </div>

                        <div class="detail-row"
                            *ngIf="selectedFundingOption && selectedFundingOption.payback && selectedFundingOption.payback > 0">
                            <div class="detail-item full-width">
                                <span class="detail-label">Total Payback:</span>
                                <span class="detail-value highlight">${{selectedFundingOption?.payback |
                                    number:'1.0-0'}}</span>
                            </div>
                        </div>
                    </div>

                    <div class="selection-id">
                        <span class="id-label">Selection ID:</span>
                        <span class="id-value">{{selectedOffer}}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Confirmation Modal -->
    <div class="modal-overlay" *ngIf="showWithdrawModal" (click)="closeWithdrawModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Withdraw Funds</h3>
                <button type="button" class="modal-close" (click)="closeWithdrawModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div class="withdrawal-summary">
                    <div class="summary-icon">üí∞</div>
                    <div class="summary-text">
                        <p class="summary-title">You are about to withdraw:</p>
                        <p class="summary-amount">{{currentBalance | currency:'USD':'symbol':'1.2-2'}}</p>
                    </div>
                </div>

                <!-- Bank Information Form -->
                <div class="bank-form-section">
                    <h4 class="form-title">Bank Account Information</h4>
                    <form #bankForm="ngForm" class="bank-form">
                        <div class="form-group">
                            <label for="accountHolderName" class="form-label">Account Holder Name *</label>
                            <input type="text" id="accountHolderName" name="accountHolderName" class="form-input"
                                [(ngModel)]="bankInfo.accountHolderName" required
                                placeholder="Enter full name as it appears on your account">
                        </div>

                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="routingNumber" class="form-label">Routing Number *</label>
                                <input type="text" id="routingNumber" name="routingNumber" class="form-input"
                                    [(ngModel)]="bankInfo.routingNumber" required maxlength="9" pattern="[0-9]{9}"
                                    placeholder="9 digits">
                            </div>

                            <div class="form-group half-width">
                                <label for="accountNumber" class="form-label">Account Number *</label>
                                <input type="text" id="accountNumber" name="accountNumber" class="form-input"
                                    [(ngModel)]="bankInfo.accountNumber" required maxlength="17"
                                    placeholder="Account number">
                            </div>
                        </div>

                    
                            <div class="form-group">
                                <label for="bankName" class="form-label">Bank Name *</label>
                                <input type="text" id="bankName" name="bankName" class="form-input"
                                    [(ngModel)]="bankInfo.bankName" required placeholder="Bank name">
                            </div>
                    
                    </form>
                </div>

                <div class="withdrawal-details">
                    <div class="detail-item">
                        <span class="detail-label">Available Balance:</span>
                        <span class="detail-value">{{currentBalance | currency:'USD':'symbol':'1.2-2'}}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Processing Time:</span>
                        <span class="detail-value">1-3 business days</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Withdrawal Method:</span>
                        <span class="detail-value">ACH Bank Transfer</span>
                    </div>
                </div>

                <div class="withdrawal-warning">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <p class="warning-text">
                        This action will transfer your entire available balance to the bank account provided above.
                        Please ensure all bank details are correct before proceeding.
                    </p>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="form-btn secondary-btn" (click)="closeWithdrawModal()"
                    [disabled]="isProcessing">
                    Cancel
                </button>
                <button type="button" class="form-btn primary-btn" (click)="proceedToPayment()"
                    [disabled]="isProcessing || currentBalance <= 0 || !isBankFormValid()">
                    <span *ngIf="!isProcessing">Go to Payment</span>
                    <span *ngIf="isProcessing" class="processing-text">
                        <span class="spinner"></span>
                        Processing...
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" *ngIf="showPaymentModal" (click)="closePaymentModal()">
        <div class="modal-content payment-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Payment Instructions</h3>
                <button type="button" class="modal-close" (click)="closePaymentModal()">√ó</button>
            </div>

            <div class="modal-body">
                <div class="payment-summary">
                    <div class="summary-icon">üí≥</div>
                    <div class="summary-text">
                        <p class="summary-title">Amount to Pay:</p>
                        <p class="summary-amount">{{getPaymentAmount()}}</p>
                        <p class="summary-subtitle">{{selectedFundingOption?.frequency}} Payment</p>
                    </div>
                </div>

                <!-- Bank Transfer Instructions -->
                <div class="bank-instructions">
                    <h4 class="instructions-title">Please transfer the payment to the following account:</h4>

                    <div class="bank-details-card">
                        <div class="bank-detail-row">
                            <div class="detail-group">
                                <span class="detail-label">Bank Name:</span>
                                <div class="detail-value-container">
                                    <span class="detail-value">{{paymentBankInfo.bankName}}</span>
                                    <button type="button" class="copy-btn"
                                        (click)="copyToClipboard(paymentBankInfo.bankName)"
                                        title="Copy to clipboard">
                                        üìã
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bank-detail-row">
                            <div class="detail-group">
                                <span class="detail-label">Account Holder:</span>
                                <div class="detail-value-container">
                                    <span class="detail-value">{{paymentBankInfo.accountHolder}}</span>
                                    <button type="button" class="copy-btn"
                                        (click)="copyToClipboard(paymentBankInfo.accountHolder)"
                                        title="Copy to clipboard">
                                        üìã
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bank-detail-row">
                            <div class="detail-group half-width">
                                <span class="detail-label">Routing Number:</span>
                                <div class="detail-value-container">
                                    <span class="detail-value">{{paymentBankInfo.routingNumber}}</span>
                                    <button type="button" class="copy-btn"
                                        (click)="copyToClipboard(paymentBankInfo.routingNumber)"
                                        title="Copy to clipboard">
                                        üìã
                                    </button>
                                </div>
                            </div>

                            <div class="detail-group half-width">
                                <span class="detail-label">Account Number:</span>
                                <div class="detail-value-container">
                                    <span class="detail-value">{{paymentBankInfo.accountNumber}}</span>
                                    <button type="button" class="copy-btn"
                                        (click)="copyToClipboard(paymentBankInfo.accountNumber)"
                                        title="Copy to clipboard">
                                        üìã
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bank-detail-row">
                            <div class="detail-group">
                                <span class="detail-label">SWIFT Code:</span>
                                <div class="detail-value-container">
                                    <span class="detail-value">{{paymentBankInfo.swiftCode}}</span>
                                    <button type="button" class="copy-btn"
                                        (click)="copyToClipboard(paymentBankInfo.swiftCode)"
                                        title="Copy to clipboard">
                                        üìã
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bank-detail-row">
                            <div class="detail-group">
                                <span class="detail-label">Bank Address:</span>
                                <div class="detail-value-container">
                                    <span class="detail-value">{{paymentBankInfo.address}}</span>
                                    <button type="button" class="copy-btn"
                                        (click)="copyToClipboard(paymentBankInfo.address)"
                                        title="Copy to clipboard">
                                        üìã
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Instructions -->
                <div class="payment-instructions">
                    <h4 class="instructions-title">Important Notes:</h4>
                    <ul class="instructions-list">
                        <li>Processing time: 1-3 business days</li>
                        <li>Include your account ID ({{accountId}}) in the transfer reference</li>
                        <li>Transfer must be made from your registered bank account</li>
                        <li>Contact support if you need assistance with the transfer</li>
                    </ul>
                </div>

                <div class="payment-warning">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <p class="warning-text">
                        Please ensure all bank details are correct before making the transfer.
                        Double-check the amount and account information to avoid delays.
                    </p>
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="form-btn secondary-btn" (click)="closePaymentModal()"
                    [disabled]="isProcessing">
                    Close
                </button>
                <button type="button" class="form-btn primary-btn" (click)="finalizePayment()"
                    [disabled]="isProcessing">
                    <span *ngIf="!isProcessing">I've Made the Transfer</span>
                    <span *ngIf="isProcessing" class="processing-text">
                        <span class="spinner"></span>
                        Processing...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>