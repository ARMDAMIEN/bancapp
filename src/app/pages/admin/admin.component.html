<div class="admin-container">

    <!-- Main Content -->
    <div class="admin-content">
        <!-- Stats Overview -->
        <div class="stats-section">
            <h2 class="section-title">Dashboard Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon users">üë•</div>
                    <div class="stat-info">
                        <span class="stat-value">{{totalUsers}}</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Banking Info -->
        <div class="admin-banking-section">
            <h2 class="section-title">Admin Settings</h2>
            <app-admin-banking-info></app-admin-banking-info>
        </div>

        <!-- Users Management -->
        <div class="users-section">
            <div class="section-header">
                <h3 class="section-title">Users Management</h3>
                <div class="section-controls">
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="Search users..." [(ngModel)]="searchTerm"
                            (input)="filterUsers()">
                        <span class="search-icon">üîç</span>
                    </div>
                    <select class="filter-select" [(ngModel)]="filterStatus" (change)="filterUsers()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="suspended">Suspended</option>
                    </select>
                </div>
            </div>

            <!-- Users Table -->
            <div class="users-table-container">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Selected Offer</th>
                            <th>Status</th>
                            <th>Substep</th>
                            <th>Signature</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let user of filteredUsers" class="user-row">
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">{{user.firstName.charAt(0)}}{{user.lastName.charAt(0)}}
                                    </div>
                                    <div class="user-details">
                                        <span class="user-name">{{user.firstName}} {{user.lastName}}</span>
                                        <span class="user-id">ID: {{user.id}}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="user-email">{{user.email}}</td>
                            <td>
                                <span class="offer-badge" *ngIf="user.selectedOffer">
                                    {{formatOffer(user.selectedOffer)}}
                                </span>
                                <span class="offer-badge none" *ngIf="!user.selectedOffer">
                                    No offer selected
                                </span>
                            </td>
                            <td>
                                <span class="status-badge" [ngClass]="user.status">{{user.status}}</span>
                            </td>
                            <td>
                                <span class="substep-badge"
                                      *ngIf="user.currentSubstep"
                                      [ngClass]="user.currentSubstep">
                                    {{formatSubstep(user.currentSubstep)}}
                                </span>
                                <span class="substep-badge none" *ngIf="!user.currentSubstep">
                                    -
                                </span>
                            </td>
                            <td>
                                <span class="signature-badge" [ngClass]="user.hasSigned ? 'signed' : 'not-signed'">
                                    {{user.hasSigned ? '‚úì Signed' : '‚úó Not Signed'}}
                                </span>
                            </td>
                            <td class="last-activity">{{getValidDate(user.lastActivity) | date:'short'}}</td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="action-btn bank-info"
                                        (click)="openBankInfoModal(user)" title="Manage Bank Info">
                                        üè¶
                                    </button>
                                    <button type="button" class="action-btn signature-btn"
                                        (click)="setUserSignatureAsAdmin(user)" [disabled]="user.hasSigned"
                                        [title]="user.hasSigned ? 'Already Signed' : 'Mark as Signed'">
                                        ‚úçÔ∏è
                                    </button>
                                    <button type="button" class="action-btn view-details"
                                        (click)="viewUserDetails(user)" title="View Details">
                                        üëÅÔ∏è
                                    </button>
                                    <button type="button" class="action-btn funding-options"
                                        (click)="openFundingOptionsModal(user)" title="Set Funding Options">
                                        üí∞
                                    </button>
                                    <!-- Payment Status Button: Show only if user is at PAYMENT_PENDING substep -->
                                    <button type="button" class="action-btn payment-confirm"
                                        *ngIf="user.currentSubstep === 'payment_pending'"
                                        (click)="confirmPaymentReceived(user)"
                                        title="Confirm Payment Received">
                                        üí≥‚úì
                                    </button>
                                    <!-- Withdrawal Complete Button: Show only if user is at WITHDRAWAL_PENDING substep -->
                                    <button type="button" class="action-btn withdrawal-complete"
                                        *ngIf="user.currentSubstep === 'withdrawal_pending'"
                                        (click)="completeWithdrawal(user)"
                                        title="Complete Withdrawal">
                                        ‚è≥‚úì
                                    </button>
                                    <!-- Suspend User Button: Show if user is on dashboard and not already suspended -->
                                    <button type="button" class="action-btn suspend-user"
                                        *ngIf="user.currentSubstep !== 'suspended' && user.currentStep === 'dashboard'"
                                        (click)="suspendUser(user)"
                                        title="Suspend User Account">
                                        üö´
                                    </button>
                                    <!-- Unsuspend User Button: Show only if user is suspended -->
                                    <button type="button" class="action-btn unsuspend-user"
                                        *ngIf="user.currentSubstep === 'suspended'"
                                        (click)="unsuspendUser(user)"
                                        title="Reactivate User Account">
                                        ‚úÖ
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Empty State -->
                <div class="empty-state" *ngIf="filteredUsers.length === 0">
                    <div class="empty-icon">üë§</div>
                    <p class="empty-text">No users found</p>
                    <p class="empty-subtext">Try adjusting your search or filter criteria</p>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination" *ngIf="totalPages > 1">
                <button type="button" class="pagination-btn" [disabled]="currentPage === 1"
                    (click)="changePage(currentPage - 1)">
                    Previous
                </button>
                <span class="pagination-info">
                    Page {{currentPage}} of {{totalPages}}
                </span>
                <button type="button" class="pagination-btn" [disabled]="currentPage === totalPages"
                    (click)="changePage(currentPage + 1)">
                    Next
                </button>
            </div>
        </div>
    </div>
</div>


<!-- User Details Modal -->
<div class="modal-overlay" *ngIf="showUserDetailsModal" (click)="closeUserDetailsModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">
                User Details - {{selectedUserDetails?.firstName}} {{selectedUserDetails?.lastName}}
            </h3>
            <button type="button" class="modal-close" (click)="closeUserDetailsModal()">√ó</button>
        </div>

        <div class="modal-body">
            <!-- Personal Information -->
            <div class="detail-section">
                <h4 class="section-title">Personal Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Full Name:</span>
                        <span class="detail-value">{{selectedUserDetails?.firstName}}
                            {{selectedUserDetails?.lastName}}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">{{selectedUserDetails?.email}}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">SSN:</span>
                        <span class="detail-value">{{formatSSN(selectedUserDetails?.ssn || '')}}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Date of Birth:</span>
                        <span class="detail-value">
                            {{selectedUserDetails?.dateOfBirth | date:'mediumDate'}}
                            (Age: {{calculateAge(selectedUserDetails?.dateOfBirth || '')}})
                        </span>
                    </div>
                </div>
            </div>

            <!-- Business Information -->
            <div class="detail-section">
                <h4 class="section-title">Business Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Company Name:</span>
                        <span class="detail-value">{{selectedUserDetails?.companyName || 'N/A'}}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Company Created:</span>
                        <span class="detail-value">
                            {{selectedUserDetails?.companyCreationDate | date:'mediumDate'}}
                            <span *ngIf="selectedUserDetails?.companyCreationDate">
                                ({{calculateCompanyAge(selectedUserDetails?.companyCreationDate)}} years)
                            </span>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">EIN Number:</span>
                        <span class="detail-value">{{selectedUserDetails?.einNumber || 'N/A'}}</span>
                    </div>
                </div>
            </div>

            <!-- Account Information -->
            <div class="detail-section">
                <h4 class="section-title">Account Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Account Balance:</span>
                        <span class="detail-value"
                            [ngClass]="getBalanceClass(selectedUserDetails?.accountBalance || 0)">
                            {{selectedUserDetails?.accountBalance | currency:'EUR':'symbol':'1.2-2'}}
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Last Balance Update:</span>
                        <span class="detail-value">{{formatBackendDate(selectedUserDetails?.lastBalanceUpdate) | date:'medium'}}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="status-badge"
                            [ngClass]="selectedUserDetails?.status">{{selectedUserDetails?.status}}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Member Since:</span>
                        <span class="detail-value">{{selectedUserDetails?.createdAt | date:'mediumDate'}}</span>
                    </div>
                </div>
            </div>

            <!-- Documents Section -->
            <!-- Documents Section -->
            <div class="detail-section">
                <h4 class="section-title">User Documents</h4>

                <!-- Check if user has any documents -->
                <div *ngIf="hasAnyDocuments(selectedUserDetails!); else noDocuments">
                    <p class="documents-uploaded" *ngIf="selectedUserDetails?.documentsUploadDate">
                        Documents uploaded on: {{formatBackendDate(selectedUserDetails?.documentsUploadDate) | date:'medium'}}
                    </p>

                    <!-- RIB Documents -->
                    <div class="document-category" *ngIf="hasRibDocuments(selectedUserDetails!)">
                        <h5 class="category-title">RIB Documents</h5>
                        <div class="document-list">
                            <div class="document-item" *ngIf="selectedUserDetails?.rib1Path">
                                <span class="doc-name">RIB Month 1</span>
                                <button class="download-btn" (click)="downloadDocument(selectedUserDetails!, 'rib1')">
                                    Download
                                </button>
                            </div>
                            <div class="document-item" *ngIf="selectedUserDetails?.rib2Path">
                                <span class="doc-name">RIB Month 2</span>
                                <button class="download-btn" (click)="downloadDocument(selectedUserDetails!, 'rib2')">
                                    Download
                                </button>
                            </div>
                            <div class="document-item" *ngIf="selectedUserDetails?.rib3Path">
                                <span class="doc-name">RIB Month 3</span>
                                <button class="download-btn" (click)="downloadDocument(selectedUserDetails!, 'rib3')">
                                    Download
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Identity Documents -->
                    <div class="document-category" *ngIf="hasIdentityDocuments(selectedUserDetails!)">
                        <h5 class="category-title">Identity Documents</h5>
                        <div class="document-list">
                            <div class="document-item" *ngIf="selectedUserDetails?.driverLicensePath">
                                <span class="doc-name">Driver License</span>
                                <button class="download-btn"
                                    (click)="downloadDocument(selectedUserDetails!, 'driverLicense')">
                                    Download
                                </button>
                            </div>
                            <div class="document-item" *ngIf="selectedUserDetails?.voidedCheckPath">
                                <span class="doc-name">Voided Check</span>
                                <button class="download-btn"
                                    (click)="downloadDocument(selectedUserDetails!, 'voidedCheck')">
                                    Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <ng-template #noDocuments>
                    <p class="no-documents">No documents uploaded yet</p>
                </ng-template>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="form-btn secondary-btn" (click)="closeUserDetailsModal()">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Funding Options Modal -->
<div class="modal-overlay" *ngIf="showFundingOptionsModal" (click)="closeFundingOptionsModal()">
    <div class="modal-content large" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title">
                Set Funding Options - {{selectedFundingUser?.firstName}} {{selectedFundingUser?.lastName}}
            </h3>
            <button type="button" class="modal-close" (click)="closeFundingOptionsModal()">√ó</button>
        </div>

        <div class="modal-body">
            <!-- User Info Summary -->
            <div class="user-summary">
                <div class="user-avatar large">
                    {{selectedFundingUser?.firstName?.charAt(0)}}{{selectedFundingUser?.lastName?.charAt(0)}}
                </div>
                <div class="user-summary-info">
                    <h4 class="summary-name">{{selectedFundingUser?.firstName}} {{selectedFundingUser?.lastName}}</h4>
                    <p class="summary-email">{{selectedFundingUser?.email}}</p>
                </div>
            </div>

            <!-- Instructions -->
            <div class="funding-instructions">
                <div class="instruction-icon">üí°</div>
                <p class="instruction-text">
                    Create a custom banking option for this user. This option will be applied to all funding categories.
                </p>
            </div>

            <!-- Single Banking Option Form -->
            <div class="funding-option-form single-form">
                <div class="form-section-title">Configure Banking Option (Applied to All Categories)</div>

                <div class="form-grid">
                    <!-- Row 1 -->
                    <div class="form-field">
                        <label class="field-label">Title *</label>
                        <input type="text" class="field-input"
                               [(ngModel)]="customBankingOption.title"
                               placeholder="e.g., Term Loan">
                    </div>

                    <div class="form-field">
                        <label class="field-label">Badge *</label>
                        <input type="text" class="field-input"
                               [(ngModel)]="customBankingOption.badge"
                               placeholder="e.g., Guaranteed">
                    </div>

                    <div class="form-field">
                        <label class="field-label">Type *</label>
                        <select class="field-input" [(ngModel)]="customBankingOption.type">
                            <option value="guarantee">Guaranteed</option>
                            <option value="mca">MCA</option>
                            <option value="capital">Capital</option>
                            <option value="long">Long Term</option>
                            <option value="short">Short Term</option>
                        </select>
                    </div>

                    <!-- Row 2 -->
                    <div class="form-field">
                        <label class="field-label">Amount ($) *</label>
                        <input type="number" class="field-input"
                               [(ngModel)]="customBankingOption.amount"
                               placeholder="e.g., 1000000"
                               min="0">
                    </div>

                    <div class="form-field">
                        <label class="field-label">Structure *</label>
                        <input type="text" class="field-input"
                               [(ngModel)]="customBankingOption.structure"
                               placeholder="e.g., Guaranteed">
                    </div>

                    <div class="form-field">
                        <label class="field-label">Payback ($) *</label>
                        <input type="number" class="field-input"
                               [(ngModel)]="customBankingOption.payback"
                               placeholder="e.g., 1200000"
                               min="0">
                    </div>

                    <!-- Row 3 -->
                    <div class="form-field">
                        <label class="field-label">Term *</label>
                        <input type="text" class="field-input"
                               [(ngModel)]="customBankingOption.term"
                               placeholder="e.g., 60 months">
                    </div>

                    <div class="form-field">
                        <label class="field-label">Payment *</label>
                        <input type="text" class="field-input"
                               [(ngModel)]="customBankingOption.payment"
                               placeholder="e.g., $20K/mo">
                    </div>

                    <div class="form-field">
                        <label class="field-label">Frequency *</label>
                        <select class="field-input" [(ngModel)]="customBankingOption.frequency">
                            <option value="Monthly">Monthly</option>
                            <option value="Weekly">Weekly</option>
                            <option value="Daily">Daily</option>
                            <option value="Quarterly">Quarterly</option>
                        </select>
                    </div>

                    <!-- Row 4 -->
                    <div class="form-field full-width">
                        <label class="field-label">Delay *</label>
                        <input type="text" class="field-input"
                               [(ngModel)]="customBankingOption.delay"
                               placeholder="e.g., Same day funding">
                    </div>
                </div>

                <!-- Preview -->
                <div class="form-preview" *ngIf="isSingleFormValid()">
                    <div class="preview-badge">Preview:</div>
                    <div class="preview-details">
                        <div class="preview-row">
                            <span class="preview-label">{{customBankingOption.title}}</span>
                            <span class="preview-value badge-preview">{{customBankingOption.badge}}</span>
                        </div>
                        <div class="preview-row">
                            <span class="preview-label">Amount:</span>
                            <span class="preview-value amount">{{customBankingOption.amount | currency:'USD':'symbol':'1.0-0'}}</span>
                        </div>
                        <div class="preview-row">
                            <span class="preview-label">Payment:</span>
                            <span class="preview-value">{{customBankingOption.payment}} ({{customBankingOption.frequency}})</span>
                        </div>
                        <div class="preview-row">
                            <span class="preview-label">Term:</span>
                            <span class="preview-value">{{customBankingOption.term}}</span>
                        </div>
                        <div class="preview-row">
                            <span class="preview-label">Payback:</span>
                            <span class="preview-value">{{customBankingOption.payback | currency:'USD':'symbol':'1.0-0'}}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Info -->
            <div class="categories-info">
                <div class="info-icon">‚ÑπÔ∏è</div>
                <div class="info-text">
                    <strong>This banking option will be created for all {{fundingCategories.length}} funding categories:</strong>
                    <ul class="categories-list">
                        <li *ngFor="let category of fundingCategories">{{category.title}}</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="modal-actions">
            <button type="button" class="form-btn secondary-btn"
                    (click)="closeFundingOptionsModal()"
                    [disabled]="isSavingFundingOptions">
                Cancel
            </button>
            <button type="button" class="form-btn primary-btn"
                    (click)="saveFundingOptions()"
                    [disabled]="!isSingleFormValid() || isSavingFundingOptions">
                <span *ngIf="!isSavingFundingOptions">Save Banking Option for All Categories</span>
                <span *ngIf="isSavingFundingOptions" class="processing-text">
                    <span class="spinner"></span>
                    Saving...
                </span>
            </button>
        </div>
    </div>
</div>

<!-- Bank Info Modal -->
<app-bank-info
    [show]="showBankInfoModal"
    [userId]="selectedBankInfoUser?.id || null"
    (close)="closeBankInfoModal()"
    (saved)="onBankInfoSaved($event)">
</app-bank-info>